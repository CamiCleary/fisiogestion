{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calendario - Fisiogestión</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="shortcut icon" href="{% static 'images/logo2.png' %}" type="image/x-icon">

  <style>
    /* Estilos globales y de la barra lateral (copiados y adaptados) */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }

    body {
      display: flex;
      background-color: #f0faf9;
      min-height: 100vh;
      color: #333;
    }

    .sidebar {
      width: 240px;
      background-color: #eaf6fb;
      padding: 32px 20px 20px 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
      flex-shrink: 0;
    }

    .logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .logo img {
      width: 130px;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .nav a {
      text-decoration: none;
      color: #0a4d68;
      padding: 10px 15px;
      border-radius: 8px;
      transition: 0.3s ease;
      font-weight: 500;
      background: transparent;
      font-size: 16px;
    }

    .nav a.active, .nav a:hover {
      background-color: #b6e6f2;
      color: #0a4d68;
    }

    .admin {
      font-size: 14px;
      color: #666;
      text-align: center;
      margin-top: 30px;
    }

    .main {
      flex-grow: 1;
      padding: 40px;
      display: flex;
      gap: 30px;
      align-items: flex-start;
      overflow-y: auto;
      position: relative;
    }

    /* Contenedor principal del calendario y formulario */
    .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 30px; /* Espacio entre calendario/form y lista de consultas */
        max-width: 1200px;
        margin: 0 auto;
    }

    .calendar-form-section {
        display: flex;
        gap: 30px;
        width: 100%;
        flex-wrap: wrap; /* Permite que el calendario y el formulario se envuelvan */
        justify-content: center;
    }

    /* Estilos del contenedor del calendario */
    .calendario-container {
        background: white;
        padding: 38px 32px 32px 32px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        flex: 2; /* Ocupa más espacio que el formulario */
        min-width: 400px;
        max-width: 700px; /* Limitar el ancho para que no sea demasiado grande */
    }

    .calendario-container h2 {
      color: #008f86;
      margin-bottom: 18px;
      font-size: 1.5em;
      text-align: center;
    }

    /* CUSTOM CALENDAR STYLES */
    #calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        color: #0a4d68;
        font-size: 1.5em;
        font-weight: bold;
    }

    #calendar-header .nav-buttons {
        display: flex;
        gap: 10px;
    }

    #calendar-header button {
        background-color: #00b89f;
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.9em;
    }

    #calendar-header button:hover {
        background-color: #009e8a;
    }

    #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr); /* 7 columnas para los días de la semana */
        gap: 5px;
    }

    .day-name {
        text-align: center;
        font-weight: bold;
        color: #0a4d68;
        padding: 10px 5px;
        font-size: 0.9em;
    }

    .calendar-day {
        background-color: #f8fafc;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        min-height: 80px; /* Altura para las celdas del día */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 5px;
        font-weight: bold;
        color: #333;
        transition: background-color 0.2s, border-color 0.2s;
        cursor: pointer;
        font-size: 1.1em;
    }

    .calendar-day.empty {
        background-color: #eaf6fb;
        border-color: #e0e0e0;
        cursor: default;
    }

    .calendar-day:not(.empty):hover {
        background-color: #e0f2f7; /* Hover effect for active days */
        border-color: #a7d9e7;
    }

    /* Styles for days with events */
    .calendar-day.has-event {
        background-color: #ccfbf1; /* Light green background for days with events */
        border: 1px solid #00b89f; /* Teal border */
    }

    .calendar-day.has-event .event-dot {
        width: 8px;
        height: 8px;
        background-color: #00b89f; /* Teal color for the dot */
        border-radius: 50%;
        margin-top: 5px; /* Space between number and dot */
        display: block; /* To center it below the number */
    }

    .calendar-day.today {
        border: 2px solid #008f86; /* Highlight today's date */
        background-color: #eaf9f6;
    }

    .calendar-day.today.has-event {
        background-color: #a7f3d0; /* Even lighter green for today with events */
        border-color: #008f86;
    }


    /* Estilos del formulario de agendar cita (manteniendo los anteriores) */
    .form-container {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        flex: 1;
        min-width: 300px;
        max-width: 450px;
    }

    .form-container h3 {
        color: #0a4d68;
        margin-bottom: 20px;
        text-align: center;
        font-size: 1.3em;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
    }

    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.2s ease-in-out;
    }

    .form-control:focus {
        outline: none;
        border-color: #008f86;
        box-shadow: 0 0 0 0.2rem rgba(0, 143, 134, 0.25);
    }

    .btn-submit {
        background-color: #00b89f;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        width: 100%;
        margin-top: 15px;
    }

    .btn-submit:hover {
        background-color: #009e8a;
    }

    /* Mensajes de Django */
    .messages {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
        width: 100%;
        text-align: center;
    }
    .messages li {
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        font-weight: 500;
    }
    .messages .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .messages .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .messages .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    .messages .warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }

    /* Sección de Citas del Día */
    .daily-appointments-section {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        width: 100%;
        margin-top: 20px; /* Espacio con la sección superior */
    }

    .daily-appointments-section h3 {
        color: #0a4d68;
        margin-bottom: 20px;
        text-align: center;
        font-size: 1.3em;
    }

    #dailyAppointmentsList {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #dailyAppointmentsList li {
        background-color: #f0faf9;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap; /* Permite que los elementos se envuelvan */
    }

    #dailyAppointmentsList li strong {
        color: #008f86;
        font-size: 1.1em;
        flex-basis: 100%; /* Ocupa todo el ancho en móviles */
        margin-bottom: 5px;
    }

    #dailyAppointmentsList li span {
        font-size: 0.95em;
        color: #555;
        flex-grow: 1; /* Permite que la información ocupe el espacio */
    }

    #dailyAppointmentsList .actions {
        display: flex;
        gap: 8px;
        margin-top: 10px; /* Espacio superior para los botones en móviles */
        flex-basis: 100%; /* Ocupa todo el ancho en móviles */
        justify-content: flex-end; /* Alinea los botones a la derecha */
    }

    #dailyAppointmentsList .actions .btn-editar,
    #dailyAppointmentsList .actions .btn-eliminar {
        padding: 8px 15px;
        border: none;
        border-radius: 8px;
        font-size: 0.9em;
        cursor: pointer;
        transition: background 0.2s;
        text-decoration: none;
        color: white;
    }

    #dailyAppointmentsList .actions .btn-editar {
        background-color: #ffc107;
        color: #333;
    }
    #dailyAppointmentsList .actions .btn-editar:hover {
        background-color: #e0a800;
    }
    #dailyAppointmentsList .actions .btn-eliminar {
        background-color: #e74c3c;
    }
    #dailyAppointmentsList .actions .btn-eliminar:hover {
        background-color: #c0392b;
    }

    /* Estilos para responsividad */
    @media (max-width: 1100px) {
      body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        padding: 15px 20px;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }
      .sidebar .logo {
        margin-bottom: 0;
      }
      .sidebar .nav {
        flex-direction: row;
        gap: 8px;
        margin-bottom: 0;
        flex-wrap: wrap;
        justify-content: center;
      }
      .sidebar .nav a {
        padding: 8px 12px;
        font-size: 15px;
      }
      .sidebar .admin {
        display: none;
      }
      .main {
        padding: 20px;
        flex-direction: column;
        align-items: center;
      }
      .content-area {
        gap: 20px;
        padding: 0;
      }
      .calendar-form-section {
        flex-direction: column; /* Apila el calendario y el formulario */
        gap: 20px;
      }
      .calendario-container, .form-container {
        max-width: 100%;
        padding: 25px 20px;
        min-width: unset; /* Elimina min-width para móviles */
      }
      /* Ajustes para el calendario custom en responsividad */
      #calendar-grid {
          gap: 3px;
      }
      .calendar-day {
          min-height: 60px; /* Reducir altura en móviles */
          font-size: 1em;
      }
      .calendar-day .event-dot {
          margin-top: 3px;
      }
    }

    @media (max-width: 768px) {
      .sidebar .nav a {
        font-size: 13px;
        padding: 7px 10px;
      }
      .main {
        padding: 15px;
      }
      .calendario-container, .form-container, .daily-appointments-section {
        padding: 20px 15px;
      }
      .form-group label {
        font-size: 14px;
      }
      .form-control, .btn-submit {
        font-size: 14px;
        padding: 10px 12px;
      }
    }

    @media (max-width: 480px) {
        .sidebar .nav {
            justify-content: space-around;
        }
        .sidebar .nav a {
            flex-grow: 1;
            text-align: center;
        }
        .form-container {
            padding: 15px;
        }
        #calendar-header {
            font-size: 1.2em;
        }
        #calendar-header button {
            font-size: 0.8em;
            padding: 6px 10px;
        }
        .calendar-day {
            font-size: 0.9em;
            min-height: 50px;
        }
    }
  </style>
</head>
<body>

  <div class="main">
    <!-- Icono de cerrar sesión -->
    <div style="margin-bottom: 5px;">
      <a href="{% url 'citas' %}" style="display: inline-flex; align-items: center; gap: 8px; background: #00b89f; color: #fff; text-decoration: none; padding: 10px 18px; border-radius: 6px; font-weight: 600;">
        <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><path d="M12.5 15l-5-5 5-5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </a>
    </div>
    <div class="content-area">
        <div class="calendar-form-section">
            <!-- Contenedor del Calendario CUSTOM -->
            <div class="calendario-container">
              <h2>Calendario de Citas</h2>
              <div id='calendar'>
                <div id="calendar-header">
                  <div class="nav-buttons">
                    <button id="prevMonth">&lt;</button>
                    <button id="todayButton">Hoy</button> 
                    <button id="nextMonth">&gt;</button>
                  </div>
                  <span id="currentMonthYear"></span>
                </div>
                <div id="calendar-grid">
                  <!-- Day names -->
                  <div class="day-name">Lun</div>
                  <div class="day-name">Mar</div>
                  <div class="day-name">Mié</div>
                  <div class="day-name">Jue</div>
                  <div class="day-name">Vie</div>
                  <div class="day-name">Sáb</div>
                  <div class="day-name">Dom</div>
                  <!-- Days will be populated by JavaScript -->
                </div>
              </div>
            </div>

            <!-- Contenedor del Formulario para Agendar Cita -->
            <div class="form-container">
              <h3>Agendar Nueva Cita</h3>
              
              <!-- Mensajes del formulario (implementados con JS) -->
              <div id="form-messages"></div>

              <form id="agendar-cita-form" method="post" action="{% url 'calendario' %}"> {# ACTION PARA API #}
                {% csrf_token %} {# Mantener para compatibilidad si vuelves a Django #}
                <input type="hidden" id="selected-date-input" name="selected_date">
                
                <div class="form-group">
                    <label for="fisioterapeuta-select">Fisioterapeuta:</label>
                    <select id="fisioterapeuta-select" name="fisioterapeuta_id" class="form-control" required> {# CAMBIADO A fisioterapeuta_id #}
                        <option value="">--- Selecciona un Fisioterapeuta ---</option>
                        {# Estas opciones deben ser generadas por Django en una aplicación real #}
                        {# Por ejemplo, en tu view, pasarías `fisioterapeutas = Usuario.objects.filter(rol=Usuario.FISIOTERAPEUTA)` #}
                        {# Y aquí harías un bucle: {% for fisio in fisioterapeutas %}<option value="{{ fisio.id }}">{{ fisio.nombre }} {{ fisio.apellido }}</option>{% endfor %} #}
                        <option value="1">Dr. Juan Perez (ID 1)</option> {# Ejemplo con ID #}
                        <option value="2">Dra. Maria Lopez (ID 2)</option> {# Ejemplo con ID #}
                        <option value="3">Dr. Carlos Gomez (ID 3)</option> {# Ejemplo con ID #}
                    </select>
                </div>
                <div class="form-group">
                    <label for="hora-inicio">Hora de Inicio:</label>
                    <input type="time" id="hora-inicio" name="hora_inicio" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="hora-fin">Hora de Fin:</label>
                    <input type="time" id="hora-fin" name="hora_fin" class="form-control" required>
                </div>
                
                <button type="submit" class="btn-submit">Guardar Cita</button>
              </form>
            </div>
        </div>

        <!-- Sección de Citas del Día -->
        <div class="daily-appointments-section">
            <h3 id="dailyAppointmentsTitle">Citas del Día: Selecciona una fecha</h3>
            <ul id="dailyAppointmentsList">
                <li style="text-align: center; color: #666;">Haz clic en una fecha en el calendario para ver las citas de ese día.</li>
            </ul>
        </div>

    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const currentMonthYearEl = document.getElementById('currentMonthYear');
      const calendarGrid = document.getElementById('calendar-grid');
      const prevMonthBtn = document.getElementById('prevMonth');
      const nextMonthBtn = document.getElementById('nextMonth');
      const todayButton = document.getElementById('todayButton'); // Get the new button

      const selectedDateInput = document.getElementById('selected-date-input');
      const fisioterapeutaSelect = document.getElementById('fisioterapeuta-select');
      const horaInicioInput = document.getElementById('hora-inicio');
      const horaFinInput = document.getElementById('hora-fin');

      const dailyAppointmentsTitle = document.getElementById('dailyAppointmentsTitle');
      const dailyAppointmentsList = document.getElementById('dailyAppointmentsList');
      const agendarCitaForm = document.getElementById('agendar-cita-form');
      const formMessagesArea = document.getElementById('form-messages');

      let currentMonth = new Date().getMonth();
      let currentYear = new Date().getFullYear();
      let eventDates = []; // This will now hold dates fetched from Django

      // Function to get CSRF token from Django
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      const csrftoken = getCookie('csrftoken');

      async function fetchEventsAndRenderCalendar() {
        try {
            // Updated URL to match potential Django setup for API
            const response = await fetch(`/api/calendario-eventos/?year=${currentYear}&month=${currentMonth + 1}`); // Month is 1-indexed for API
            if (!response.ok) {
                // If the API call fails, assume no events for now, but log the error.
                console.error('Error fetching calendar events:', response.status, response.statusText);
                eventDates = []; // No events if API fails
                // Optionally display a user message here
                // displayMessage(formMessagesArea, 'Error al cargar los eventos del calendario. (Código: ' + response.status + ')', 'error');
            } else {
                eventDates = await response.json(); // Array of 'YYYY-MM-DD' dates
            }
            renderCalendarGrid(); // Render the calendar grid with fetched events
        } catch (error) {
            console.error('Error fetching calendar events:', error);
            displayMessage(formMessagesArea, 'Error de conexión al cargar los eventos del calendario. Intente de nuevo.', 'error');
            eventDates = []; // Ensure events is empty on connection error
            renderCalendarGrid(); // Render anyway to show calendar structure
        }
      }

      function renderCalendarGrid() {
        calendarGrid.innerHTML = ''; // Clear previous days
        // Add day names (re-add them as the grid is cleared)
        const dayNames = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
        dayNames.forEach(name => {
          const dayNameEl = document.createElement('div');
          dayNameEl.className = 'day-name';
          dayNameEl.textContent = name;
          calendarGrid.appendChild(dayNameEl);
        });

        const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
        const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
        const numDaysInMonth = lastDayOfMonth.getDate();

        // Get the day of the week for the first day of the month (0=Sunday, 1=Monday, ...)
        // Adjust to make Monday=0, Sunday=6
        let firstDayOfWeek = firstDayOfMonth.getDay();
        if (firstDayOfWeek === 0) firstDayOfWeek = 6; // Sunday becomes 6
        else firstDayOfWeek--; // Monday becomes 0, Tuesday 1, etc.

        // Fill in leading empty days
        for (let i = 0; i < firstDayOfWeek; i++) {
          const emptyDay = document.createElement('div');
          emptyDay.className = 'calendar-day empty';
          calendarGrid.appendChild(emptyDay);
        }

        // Fill in actual days
        for (let day = 1; day <= numDaysInMonth; day++) {
          const dayEl = document.createElement('div');
          dayEl.className = 'calendar-day';
          dayEl.textContent = day;
          
          const fullDate = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
          dayEl.dataset.date = fullDate; // Store full date for easy access

          // Check if today
          const today = new Date();
          if (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
            dayEl.classList.add('today');
          }

          // Check for events on this day using fetched eventDates
          if (eventDates.includes(fullDate)) {
            dayEl.classList.add('has-event');
            const dot = document.createElement('span');
            dot.className = 'event-dot';
            dayEl.appendChild(dot);
          }

          dayEl.addEventListener('click', function() {
            // Set the hidden input for the selected date
            selectedDateInput.value = dayEl.dataset.date;
            
            // Clear time inputs (optional, can leave for user convenience)
            horaInicioInput.value = '';
            horaFinInput.value = '';
            fisioterapeutaSelect.value = ''; // Clear selected physiotherapist

            // Optional: auto-scroll to form
            document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
            
            // Fetch and display daily appointments
            fetchDailyAppointments(dayEl.dataset.date);
          });

          calendarGrid.appendChild(dayEl);
        }

        // Update month/year display
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        currentMonthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
      }

      function formatDateDisplay(dateString) {
          const [year, month, day] = dateString.split('-');
          const date = new Date(year, month - 1, day); // Month is 0-indexed
          const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          return date.toLocaleDateString('es-ES', options);
      }

      function displayMessage(container, message, type) {
          container.innerHTML = `<ul class="messages"><li class="${type}">${message}</li></ul>`;
          setTimeout(() => {
              container.innerHTML = '';
          }, 5000); // Clear message after 5 seconds
      }

      // Event listener for form submission
      agendarCitaForm.addEventListener('submit', async function(event) {
          event.preventDefault(); // Prevent default form submission

          const selectedDate = selectedDateInput.value;
          const fisioterapeutaId = fisioterapeutaSelect.value;
          const horaInicio = horaInicioInput.value;
          const horaFin = horaFinInput.value;

          if (!selectedDate || !fisioterapeutaId || !horaInicio || !horaFin) {
              displayMessage(formMessagesArea, 'Por favor, completa todos los campos del formulario.', 'error');
              return;
          }

          const formData = new FormData();
          formData.append('fisioterapeuta_id', fisioterapeutaId); // Changed to fisioterapeuta_id to match backend
          formData.append('selected_date', selectedDate);
          formData.append('hora_inicio', horaInicio);
          formData.append('hora_fin', horaFin);
          formData.append('csrfmiddlewaretoken', csrftoken); // Add CSRF token

          try {
              // Ensure this URL matches your Django project's urls.py for agendar_cita_api
              const response = await fetch('/api/agendar-cita/', { 
                  method: 'POST',
                  body: formData, 
              });
              const data = await response.json();

              if (data.success) {
                  displayMessage(formMessagesArea, data.message, 'success');
                  // Re-fetch and re-render calendar to show new event
                  await fetchEventsAndRenderCalendar(); 
                  // Clear form fields
                  selectedDateInput.value = '';
                  fisioterapeutaSelect.value = '';
                  horaInicioInput.value = '';
                  horaFinInput.value = '';
                  // Reset daily appointments section to current day's appointments
                  const today = new Date();
                  const todayStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                  fetchDailyAppointments(todayStr); // Reload today's appointments after a new booking

              } else {
                  displayMessage(formMessagesArea, data.message, 'error');
              }
          } catch (error) {
              console.error('Error al enviar el formulario:', error);
              displayMessage(formMessagesArea, 'Error de conexión al agendar la cita. Intente de nuevo.', 'error');
          }
      });


      prevMonthBtn.addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        fetchEventsAndRenderCalendar(); // Fetch new events for the month
      });

      nextMonthBtn.addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        fetchEventsAndRenderCalendar(); // Fetch new events for the month
      });

      // New 'Hoy' button functionality
      todayButton.addEventListener('click', () => {
        const today = new Date();
        currentMonth = today.getMonth();
        currentYear = today.getFullYear();
        fetchEventsAndRenderCalendar(); // Load calendar for today's month
        const todayStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
        fetchDailyAppointments(todayStr); // Load appointments for today
      });


      // Initial render and fetch
      fetchEventsAndRenderCalendar();
      
      // Load current day's appointments on initial load
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
      fetchDailyAppointments(todayStr);

    });
  </script>
</body>
</html>
